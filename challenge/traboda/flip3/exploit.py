from pwn import *
#given auth_message =  b'admin=no!'
#expected auth_message =  b'admin=yes'

io = remote("gc1.eng.run", 30260)
print(io.recvline())
cipher = io.recvline()
print(cipher)
print(io.recvuntil("flag:"))


cipher =cipher[15:]


IV = cipher[:32]
CT = cipher[32:]

print("IV : "+IV)
print("CT : "+CT)

#First block 16 bytes =IV
# Second block 9 bytes message + 7 padding

#7,8,9 bit need to be flipped

iv3 = IV.decode("hex")

iv3 = iv3[6:-7]

iv3 = iv3.encode("hex")

print("IV needs to flipped "+iv3)

ct3 = CT[:-1].decode("hex")
#ct3 = CT.decode("hex")

ct3 = ct3[6:-7]

ct3 = ct3.encode("hex")

print("Cipher bits "+ct3)

wrongbits = b'no!'

wrongbits2 = wrongbits.encode("hex")
print("XOR "+iv3+" With "+wrongbits2)

a = xor(iv3[:2].decode("hex") ,wrongbits2[:2].decode("hex"))

b = xor(iv3[2:-2].decode("hex") , wrongbits2[2:-2].decode("hex"))

c = xor(iv3[4:].decode("hex") ,wrongbits2[4:].decode("hex"))

print("xoring "+iv3[:2] +" With "+wrongbits2[:2]+ "  gives "+a.encode("hex"))

print("xoring "+iv3[2:-2] +" With "+wrongbits2[2:-2]+ "  gives "+b.encode("hex"))

print("xoring "+iv3[4:] +" With "+wrongbits2[4:]+ "  gives "+c.encode("hex"))

print("\n")

print("expected value `yes` in hex "+"yes".encode("hex"))

a1 =xor(a,"y")

a2 = xor(b,"e")

a3 = xor(c,"s")

print("\n")

print("Bytes need to be flipped "+a1.encode("hex")+a2.encode("hex")+a3.encode("hex"))

flipper = a1.encode("hex")+a2.encode("hex")+a3.encode("hex")

new_IV = IV.replace(iv3,flipper)

print("Here i am the final iv "+new_IV)

print("Send me bitch "+ new_IV+CT)

flipped_payload = new_IV+CT



io.sendline(flipped_payload)

print(io.recvline())
print(io.recvline())
